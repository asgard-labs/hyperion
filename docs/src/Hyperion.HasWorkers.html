<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# OPTIONS_GHC -fno-warn-orphans  #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts      #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE FlexibleInstances     #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE MultiParamTypeClasses #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes            #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards       #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables   #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE StaticPointers        #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications      #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies          #-}</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Hyperion.HasWorkers</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-13"></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Distributed.Process</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Closure</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Process</span></span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Base</span></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadBase</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.IO.Class</span></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadIO</span></span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Reader</span></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ReaderT</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">asks</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">runReaderT</span></span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Binary</span></span><span>                 </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Binary</span></span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Constraint</span></span><span>             </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Dict</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Typeable</span></span><span>               </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Typeable</span></span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Hyperion.Remote.html"><span class="hs-identifier">Hyperion.Remote</span></a></span><span>             </span><span class="hs-special">(</span><span class="annot"><a href="Hyperion.Remote.html#RemoteProcessRunner"><span class="hs-identifier">RemoteProcessRunner</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-22"></span><span>                                              </span><span class="annot"><a href="Hyperion.Remote.html#WorkerLauncher"><span class="hs-identifier">WorkerLauncher</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-23"></span><span>                                              </span><span class="annot"><a href="Hyperion.Remote.html#mkSerializableClosureProcess"><span class="hs-identifier">mkSerializableClosureProcess</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-24"></span><span>                                              </span><span class="annot"><a href="Hyperion.Remote.html#withRemoteRunProcess"><span class="hs-identifier">withRemoteRunProcess</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Hyperion.Slurm.html"><span class="hs-identifier">Hyperion.Slurm</span></a></span><span>              </span><span class="hs-special">(</span><span class="annot"><a href="Hyperion.Slurm.JobId.html#JobId"><span class="hs-identifier">JobId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Hyperion.Static</span></span><span>             </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Serializable</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Static</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span>
</span><span id="line-28"></span><span class="hs-comment">-- | A class for monads that can run things in the 'Process' monad,</span><span>
</span><span id="line-29"></span><span class="hs-comment">-- and have access to a 'WorkerLauncher'. An instance of 'HasWorkers'</span><span>
</span><span id="line-30"></span><span class="hs-comment">-- can use 'remoteBind' and 'remoteEval' to run computations in worker</span><span>
</span><span id="line-31"></span><span class="hs-comment">-- processes at remote locations.</span><span>
</span><span id="line-32"></span><span class="hs-keyword">class</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadBase</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Process</span></span><span> </span><span class="annot"><a href="#local-6989586621679163153"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hyperion.HasWorkers.html#MonadUnliftProcess"><span class="hs-identifier hs-type">MonadUnliftProcess</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679163153"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679163153"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span id="HasWorkers"><span class="annot"><a href="Hyperion.HasWorkers.html#HasWorkers"><span class="hs-identifier hs-var">HasWorkers</span></a></span></span><span> </span><span id="local-6989586621679163153"><span class="annot"><a href="#local-6989586621679163153"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-33"></span><span>  </span><span id="getWorkerLauncher"><span class="annot"><a href="Hyperion.HasWorkers.html#getWorkerLauncher"><span class="hs-identifier hs-type">getWorkerLauncher</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679163153"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hyperion.Remote.html#WorkerLauncher"><span class="hs-identifier hs-type">WorkerLauncher</span></a></span><span> </span><span class="annot"><a href="Hyperion.Slurm.JobId.html#JobId"><span class="hs-identifier hs-type">JobId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span>
</span><span id="line-35"></span><span class="hs-comment">-- | Trivial orphan instance of 'MonadBase' for 'Process'.</span><span>
</span><span id="line-36"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadBase</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Process</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Process</span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-37"></span><span>  </span><span id="local-6989586621679163109"><span class="annot"><span class="annottext">liftBase :: Process &#945; -&gt; Process &#945;
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">liftBase</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Process &#945; -&gt; Process &#945;
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span>
</span><span id="line-38"></span><span>
</span><span id="line-39"></span><span class="hs-comment">-- | A class for Monads that can run continuations in the Process</span><span>
</span><span id="line-40"></span><span class="hs-comment">-- monad, modeled after MonadUnliftIO</span><span>
</span><span id="line-41"></span><span class="hs-comment">-- (https://hackage.haskell.org/package/unliftio-core-0.2.0.1/docs/Control-Monad-IO-Unlift.html).</span><span>
</span><span id="line-42"></span><span class="hs-keyword">class</span><span> </span><span id="MonadUnliftProcess"><span class="annot"><a href="Hyperion.HasWorkers.html#MonadUnliftProcess"><span class="hs-identifier hs-var">MonadUnliftProcess</span></a></span></span><span> </span><span id="local-6989586621679163182"><span class="annot"><a href="#local-6989586621679163182"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-43"></span><span>  </span><span id="local-6989586621679163184"><span id="withRunInProcess"><span class="annot"><a href="Hyperion.HasWorkers.html#withRunInProcess"><span class="hs-identifier hs-type">withRunInProcess</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679163181"><span class="annot"><a href="#local-6989586621679163181"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="#local-6989586621679163182"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679163181"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Process</span></span><span> </span><span class="annot"><a href="#local-6989586621679163181"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Process</span></span><span> </span><span class="annot"><a href="#local-6989586621679163184"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679163182"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679163184"><span class="hs-identifier hs-type">b</span></a></span></span><span>
</span><span id="line-44"></span><span>
</span><span id="line-45"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hyperion.HasWorkers.html#MonadUnliftProcess"><span class="hs-identifier hs-type">MonadUnliftProcess</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Process</span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-46"></span><span>  </span><span id="local-6989586621679163103"><span class="annot"><span class="annottext">withRunInProcess :: ((forall &#945;. Process &#945; -&gt; Process &#945;) -&gt; Process b) -&gt; Process b
</span><a href="#local-6989586621679163103"><span class="hs-identifier hs-var hs-var hs-var hs-var">withRunInProcess</span></a></span></span><span> </span><span id="local-6989586621679163102"><span class="annot"><span class="annottext">(forall &#945;. Process &#945; -&gt; Process &#945;) -&gt; Process b
</span><a href="#local-6989586621679163102"><span class="hs-identifier hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(forall &#945;. Process &#945; -&gt; Process &#945;) -&gt; Process b
</span><a href="#local-6989586621679163102"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; a
forall &#945;. Process &#945; -&gt; Process &#945;
</span><span class="hs-identifier hs-var">id</span></span><span>
</span><span id="line-47"></span><span>
</span><span id="line-48"></span><span id="local-6989586621679163100"><span id="local-6989586621679163101"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hyperion.HasWorkers.html#MonadUnliftProcess"><span class="hs-identifier hs-type">MonadUnliftProcess</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679163101"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hyperion.HasWorkers.html#MonadUnliftProcess"><span class="hs-identifier hs-type">MonadUnliftProcess</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="annot"><a href="#local-6989586621679163100"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679163101"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-49"></span><span>  </span><span id="local-6989586621679163098"><span class="annot"><span class="annottext">withRunInProcess :: ((forall a. ReaderT r m a -&gt; Process a) -&gt; Process b)
-&gt; ReaderT r m b
</span><a href="#local-6989586621679163098"><span class="hs-identifier hs-var hs-var hs-var hs-var">withRunInProcess</span></a></span></span><span> </span><span id="local-6989586621679163097"><span class="annot"><span class="annottext">(forall a. ReaderT r m a -&gt; Process a) -&gt; Process b
</span><a href="#local-6989586621679163097"><span class="hs-identifier hs-var">inner</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-50"></span><span>    </span><span class="annot"><span class="annottext">(r -&gt; m b) -&gt; ReaderT r m b
forall r (m :: * -&gt; *) a. (r -&gt; m a) -&gt; ReaderT r m a
</span><span class="hs-identifier hs-var">ReaderT</span></span><span> </span><span class="annot"><span class="annottext">((r -&gt; m b) -&gt; ReaderT r m b) -&gt; (r -&gt; m b) -&gt; ReaderT r m b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679163095"><span class="annot"><span class="annottext">r
</span><a href="#local-6989586621679163095"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-51"></span><span>    </span><span class="annot"><span class="annottext">((forall a. m a -&gt; Process a) -&gt; Process b) -&gt; m b
forall (m :: * -&gt; *) b.
MonadUnliftProcess m =&gt;
((forall a. m a -&gt; Process a) -&gt; Process b) -&gt; m b
</span><a href="Hyperion.HasWorkers.html#withRunInProcess"><span class="hs-identifier hs-var">withRunInProcess</span></a></span><span> </span><span class="annot"><span class="annottext">(((forall a. m a -&gt; Process a) -&gt; Process b) -&gt; m b)
-&gt; ((forall a. m a -&gt; Process a) -&gt; Process b) -&gt; m b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679163094"><span class="annot"><span class="annottext">forall a. m a -&gt; Process a
</span><a href="#local-6989586621679163094"><span class="hs-identifier hs-var">run</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-52"></span><span>    </span><span class="annot"><span class="annottext">(forall a. ReaderT r m a -&gt; Process a) -&gt; Process b
</span><a href="#local-6989586621679163097"><span class="hs-identifier hs-var">inner</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">m a -&gt; Process a
forall a. m a -&gt; Process a
</span><a href="#local-6989586621679163094"><span class="hs-identifier hs-var">run</span></a></span><span> </span><span class="annot"><span class="annottext">(m a -&gt; Process a)
-&gt; (ReaderT r m a -&gt; m a) -&gt; ReaderT r m a -&gt; Process a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(ReaderT r m a -&gt; r -&gt; m a) -&gt; r -&gt; ReaderT r m a -&gt; m a
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">ReaderT r m a -&gt; r -&gt; m a
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="annot"><span class="annottext">r
</span><a href="#local-6989586621679163095"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-53"></span><span>
</span><span id="line-54"></span><span class="hs-comment">-- | A class indicating that type 'env' contains a 'WorkerLauncher'.</span><span>
</span><span id="line-55"></span><span class="hs-keyword">class</span><span> </span><span id="HasWorkerLauncher"><span class="annot"><a href="Hyperion.HasWorkers.html#HasWorkerLauncher"><span class="hs-identifier hs-var">HasWorkerLauncher</span></a></span></span><span> </span><span id="local-6989586621679163148"><span class="annot"><a href="#local-6989586621679163148"><span class="hs-identifier hs-type">env</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-56"></span><span>  </span><span id="toWorkerLauncher"><span class="annot"><a href="Hyperion.HasWorkers.html#toWorkerLauncher"><span class="hs-identifier hs-type">toWorkerLauncher</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679163148"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hyperion.Remote.html#WorkerLauncher"><span class="hs-identifier hs-type">WorkerLauncher</span></a></span><span> </span><span class="annot"><a href="Hyperion.Slurm.JobId.html#JobId"><span class="hs-identifier hs-type">JobId</span></a></span><span>
</span><span id="line-57"></span><span>
</span><span id="line-58"></span><span class="hs-comment">-- | This is our main instance for 'HasWorkers'. The 'Cluster' and</span><span>
</span><span id="line-59"></span><span class="hs-comment">-- 'Job' monads are both cases of 'ReaderT env Process' with different</span><span>
</span><span id="line-60"></span><span class="hs-comment">-- 'env's.</span><span>
</span><span id="line-61"></span><span id="local-6989586621679163090"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hyperion.HasWorkers.html#HasWorkerLauncher"><span class="hs-identifier hs-type">HasWorkerLauncher</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679163090"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hyperion.HasWorkers.html#HasWorkers"><span class="hs-identifier hs-type">HasWorkers</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="annot"><a href="#local-6989586621679163090"><span class="hs-identifier hs-type">env</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Process</span></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-62"></span><span>  </span><span id="local-6989586621679163084"><span class="annot"><span class="annottext">getWorkerLauncher :: ReaderT env Process (WorkerLauncher JobId)
</span><a href="#local-6989586621679163084"><span class="hs-identifier hs-var hs-var hs-var hs-var">getWorkerLauncher</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(env -&gt; WorkerLauncher JobId)
-&gt; ReaderT env Process (WorkerLauncher JobId)
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">env -&gt; WorkerLauncher JobId
forall env. HasWorkerLauncher env =&gt; env -&gt; WorkerLauncher JobId
</span><a href="Hyperion.HasWorkers.html#toWorkerLauncher"><span class="hs-identifier hs-var">toWorkerLauncher</span></a></span></span><span>
</span><span id="line-63"></span><span>
</span><span id="line-64"></span><span class="hs-comment">-- | Uses the 'WorkerLauncher' to get a 'RemoteProcessRunner' and pass it</span><span>
</span><span id="line-65"></span><span class="hs-comment">-- to the given continuation.</span><span>
</span><span id="line-66"></span><span class="hs-comment">--</span><span>
</span><span id="line-67"></span><span class="hs-comment">-- This function is essentially a composition of 'getWorkerLauncher' with</span><span>
</span><span id="line-68"></span><span class="hs-comment">-- 'withRemoteRunProcess', lifted from 'Process' to 'm' using 'MonadUnliftProcess'.</span><span>
</span><span id="line-69"></span><span class="hs-comment">--</span><span>
</span><span id="line-70"></span><span class="hs-comment">-- We use the machinery of 'MonadUnliftProcess' because</span><span>
</span><span id="line-71"></span><span class="hs-comment">-- 'withRemoteRunProcess' expects something that runs in the 'Process'</span><span>
</span><span id="line-72"></span><span class="hs-comment">-- monad, not in 'm'. Our main use case is when 'm ~ ReaderT env</span><span>
</span><span id="line-73"></span><span class="hs-comment">-- Process', where 'env' is an instance of 'HasWorkerLauncher'.</span><span>
</span><span id="line-74"></span><span class="hs-comment">--</span><span>
</span><span id="line-75"></span><span id="local-6989586621679163134"><span id="local-6989586621679163135"><span class="annot"><a href="Hyperion.HasWorkers.html#withRemoteRun"><span class="hs-identifier hs-type">withRemoteRun</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hyperion.HasWorkers.html#HasWorkers"><span class="hs-identifier hs-type">HasWorkers</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679163135"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hyperion.Remote.html#RemoteProcessRunner"><span class="hs-identifier hs-type">RemoteProcessRunner</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679163135"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679163134"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679163135"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679163134"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-76"></span><span id="withRemoteRun"><span class="annot"><span class="annottext">withRemoteRun :: (RemoteProcessRunner -&gt; m a) -&gt; m a
</span><a href="Hyperion.HasWorkers.html#withRemoteRun"><span class="hs-identifier hs-var hs-var">withRemoteRun</span></a></span></span><span> </span><span id="local-6989586621679163082"><span class="annot"><span class="annottext">RemoteProcessRunner -&gt; m a
</span><a href="#local-6989586621679163082"><span class="hs-identifier hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-77"></span><span>  </span><span id="local-6989586621679163081"><span class="annot"><span class="annottext">WorkerLauncher JobId
</span><a href="#local-6989586621679163081"><span class="hs-identifier hs-var">workerLauncher</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (WorkerLauncher JobId)
forall (m :: * -&gt; *). HasWorkers m =&gt; m (WorkerLauncher JobId)
</span><a href="Hyperion.HasWorkers.html#getWorkerLauncher"><span class="hs-identifier hs-var">getWorkerLauncher</span></a></span><span>
</span><span id="line-78"></span><span>  </span><span class="annot"><span class="annottext">((forall a. m a -&gt; Process a) -&gt; Process a) -&gt; m a
forall (m :: * -&gt; *) b.
MonadUnliftProcess m =&gt;
((forall a. m a -&gt; Process a) -&gt; Process b) -&gt; m b
</span><a href="Hyperion.HasWorkers.html#withRunInProcess"><span class="hs-identifier hs-var">withRunInProcess</span></a></span><span> </span><span class="annot"><span class="annottext">(((forall a. m a -&gt; Process a) -&gt; Process a) -&gt; m a)
-&gt; ((forall a. m a -&gt; Process a) -&gt; Process a) -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679163080"><span class="annot"><span class="annottext">forall a. m a -&gt; Process a
</span><a href="#local-6989586621679163080"><span class="hs-identifier hs-var">runInProcess</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-79"></span><span>    </span><span class="annot"><span class="annottext">WorkerLauncher JobId
-&gt; (RemoteProcessRunner -&gt; Process a) -&gt; Process a
forall j a.
Show j =&gt;
WorkerLauncher j -&gt; (RemoteProcessRunner -&gt; Process a) -&gt; Process a
</span><a href="Hyperion.Remote.html#withRemoteRunProcess"><span class="hs-identifier hs-var">withRemoteRunProcess</span></a></span><span> </span><span class="annot"><span class="annottext">WorkerLauncher JobId
</span><a href="#local-6989586621679163081"><span class="hs-identifier hs-var">workerLauncher</span></a></span><span> </span><span class="annot"><span class="annottext">((RemoteProcessRunner -&gt; Process a) -&gt; Process a)
-&gt; (RemoteProcessRunner -&gt; Process a) -&gt; Process a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679163079"><span class="annot"><span class="annottext">RemoteProcessRunner
</span><a href="#local-6989586621679163079"><span class="hs-identifier hs-var">remoteRunProcess</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-80"></span><span>    </span><span class="annot"><span class="annottext">m a -&gt; Process a
forall a. m a -&gt; Process a
</span><a href="#local-6989586621679163080"><span class="hs-identifier hs-var">runInProcess</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RemoteProcessRunner -&gt; m a
</span><a href="#local-6989586621679163082"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteProcessRunner
</span><a href="#local-6989586621679163079"><span class="hs-identifier hs-var">remoteRunProcess</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-81"></span><span>
</span><span id="line-82"></span><span class="hs-comment">-- | Compute a closure at a remote location. The user supplies an 'm</span><span>
</span><span id="line-83"></span><span class="hs-comment">-- (Closure (...))' which is only evaluated when a remote worker</span><span>
</span><span id="line-84"></span><span class="hs-comment">-- becomes available (for example after the worker makes it out of the</span><span>
</span><span id="line-85"></span><span class="hs-comment">-- Slurm queue).</span><span>
</span><span id="line-86"></span><span id="local-6989586621679163130"><span id="local-6989586621679163131"><span class="annot"><a href="Hyperion.HasWorkers.html#remoteEvalWithDictM"><span class="hs-identifier hs-type">remoteEvalWithDictM</span></a></span><span>
</span><span id="line-87"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hyperion.HasWorkers.html#HasWorkers"><span class="hs-identifier hs-type">HasWorkers</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679163131"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Serializable</span></span><span> </span><span class="annot"><a href="#local-6989586621679163130"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Closure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Dict</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Serializable</span></span><span> </span><span class="annot"><a href="#local-6989586621679163130"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-89"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679163131"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Closure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Process</span></span><span> </span><span class="annot"><a href="#local-6989586621679163130"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-90"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679163131"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679163130"><span class="hs-identifier hs-type">b</span></a></span></span></span><span>
</span><span id="line-91"></span><span id="remoteEvalWithDictM"><span class="annot"><span class="annottext">remoteEvalWithDictM :: Closure (Dict (Serializable b)) -&gt; m (Closure (Process b)) -&gt; m b
</span><a href="Hyperion.HasWorkers.html#remoteEvalWithDictM"><span class="hs-identifier hs-var hs-var">remoteEvalWithDictM</span></a></span></span><span> </span><span id="local-6989586621679163077"><span class="annot"><span class="annottext">Closure (Dict (Serializable b))
</span><a href="#local-6989586621679163077"><span class="hs-identifier hs-var">bDict</span></a></span></span><span> </span><span id="local-6989586621679163076"><span class="annot"><span class="annottext">m (Closure (Process b))
</span><a href="#local-6989586621679163076"><span class="hs-identifier hs-var">mb</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-92"></span><span>  </span><span id="local-6989586621679163075"><span class="annot"><span class="annottext">SerializableClosureProcess b
</span><a href="#local-6989586621679163075"><span class="hs-identifier hs-var">scp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((forall a. m a -&gt; Process a)
 -&gt; Process (SerializableClosureProcess b))
-&gt; m (SerializableClosureProcess b)
forall (m :: * -&gt; *) b.
MonadUnliftProcess m =&gt;
((forall a. m a -&gt; Process a) -&gt; Process b) -&gt; m b
</span><a href="Hyperion.HasWorkers.html#withRunInProcess"><span class="hs-identifier hs-var">withRunInProcess</span></a></span><span> </span><span class="annot"><span class="annottext">(((forall a. m a -&gt; Process a)
  -&gt; Process (SerializableClosureProcess b))
 -&gt; m (SerializableClosureProcess b))
-&gt; ((forall a. m a -&gt; Process a)
    -&gt; Process (SerializableClosureProcess b))
-&gt; m (SerializableClosureProcess b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679163074"><span class="annot"><span class="annottext">forall a. m a -&gt; Process a
</span><a href="#local-6989586621679163074"><span class="hs-identifier hs-var">runInProcess</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Closure (Dict (Serializable b))
-&gt; Process (Closure (Process b))
-&gt; Process (SerializableClosureProcess b)
forall b.
Typeable b =&gt;
Closure (Dict (Serializable b))
-&gt; Process (Closure (Process b))
-&gt; Process (SerializableClosureProcess b)
</span><a href="Hyperion.Remote.html#mkSerializableClosureProcess"><span class="hs-identifier hs-var">mkSerializableClosureProcess</span></a></span><span> </span><span class="annot"><span class="annottext">Closure (Dict (Serializable b))
</span><a href="#local-6989586621679163077"><span class="hs-identifier hs-var">bDict</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">m (Closure (Process b)) -&gt; Process (Closure (Process b))
forall a. m a -&gt; Process a
</span><a href="#local-6989586621679163074"><span class="hs-identifier hs-var">runInProcess</span></a></span><span> </span><span class="annot"><span class="annottext">m (Closure (Process b))
</span><a href="#local-6989586621679163076"><span class="hs-identifier hs-var">mb</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-93"></span><span>  </span><span class="annot"><span class="annottext">(RemoteProcessRunner -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a.
HasWorkers m =&gt;
(RemoteProcessRunner -&gt; m a) -&gt; m a
</span><a href="Hyperion.HasWorkers.html#withRemoteRun"><span class="hs-identifier hs-var">withRemoteRun</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679163073"><span class="annot"><span class="annottext">RemoteProcessRunner
</span><a href="#local-6989586621679163073"><span class="hs-identifier hs-var">remoteRun</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Process b -&gt; m b
forall (b :: * -&gt; *) (m :: * -&gt; *) &#945;. MonadBase b m =&gt; b &#945; -&gt; m &#945;
</span><span class="hs-identifier hs-var">liftBase</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SerializableClosureProcess b -&gt; Process b
RemoteProcessRunner
</span><a href="#local-6989586621679163073"><span class="hs-identifier hs-var">remoteRun</span></a></span><span> </span><span class="annot"><span class="annottext">SerializableClosureProcess b
</span><a href="#local-6989586621679163075"><span class="hs-identifier hs-var">scp</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span>
</span><span id="line-95"></span><span class="hs-comment">-- | Evaluate a 'Closure' at a remote location, assuming a 'Static</span><span>
</span><span id="line-96"></span><span class="hs-comment">-- (Binary b)' instance. The Closure itself is ony computed when a</span><span>
</span><span id="line-97"></span><span class="hs-comment">-- worker becomes available.</span><span>
</span><span id="line-98"></span><span id="local-6989586621679163124"><span id="local-6989586621679163125"><span class="annot"><a href="Hyperion.HasWorkers.html#remoteEvalM"><span class="hs-identifier hs-type">remoteEvalM</span></a></span><span>
</span><span id="line-99"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hyperion.HasWorkers.html#HasWorkers"><span class="hs-identifier hs-type">HasWorkers</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679163125"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Static</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Binary</span></span><span> </span><span class="annot"><a href="#local-6989586621679163124"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Typeable</span></span><span> </span><span class="annot"><a href="#local-6989586621679163124"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-100"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679163125"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Closure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Process</span></span><span> </span><span class="annot"><a href="#local-6989586621679163124"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-101"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679163125"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679163124"><span class="hs-identifier hs-type">b</span></a></span></span></span><span>
</span><span id="line-102"></span><span id="remoteEvalM"><span class="annot"><span class="annottext">remoteEvalM :: m (Closure (Process b)) -&gt; m b
</span><a href="Hyperion.HasWorkers.html#remoteEvalM"><span class="hs-identifier hs-var hs-var">remoteEvalM</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Closure (Dict (Serializable b)) -&gt; m (Closure (Process b)) -&gt; m b
forall (m :: * -&gt; *) b.
(HasWorkers m, Serializable b) =&gt;
Closure (Dict (Serializable b)) -&gt; m (Closure (Process b)) -&gt; m b
</span><a href="Hyperion.HasWorkers.html#remoteEvalWithDictM"><span class="hs-identifier hs-var">remoteEvalWithDictM</span></a></span><span> </span><span class="annot"><span class="annottext">Closure (Dict (Serializable b))
forall (c :: Constraint). Static c =&gt; Closure (Dict c)
</span><span class="hs-identifier hs-var">closureDict</span></span><span>
</span><span id="line-103"></span><span>
</span><span id="line-104"></span><span class="hs-comment">-- | Evaluate a 'Closure' at a remote location.</span><span>
</span><span id="line-105"></span><span id="local-6989586621679163069"><span id="local-6989586621679163070"><span class="annot"><a href="Hyperion.HasWorkers.html#remoteEval"><span class="hs-identifier hs-type">remoteEval</span></a></span><span>
</span><span id="line-106"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hyperion.HasWorkers.html#HasWorkers"><span class="hs-identifier hs-type">HasWorkers</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679163070"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Static</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Binary</span></span><span> </span><span class="annot"><a href="#local-6989586621679163069"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Typeable</span></span><span> </span><span class="annot"><a href="#local-6989586621679163069"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-107"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Closure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Process</span></span><span> </span><span class="annot"><a href="#local-6989586621679163069"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-108"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679163070"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679163069"><span class="hs-identifier hs-type">b</span></a></span></span></span><span>
</span><span id="line-109"></span><span id="remoteEval"><span class="annot"><span class="annottext">remoteEval :: Closure (Process b) -&gt; m b
</span><a href="Hyperion.HasWorkers.html#remoteEval"><span class="hs-identifier hs-var hs-var">remoteEval</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m (Closure (Process b)) -&gt; m b
forall (m :: * -&gt; *) b.
(HasWorkers m, Static (Binary b), Typeable b) =&gt;
m (Closure (Process b)) -&gt; m b
</span><a href="Hyperion.HasWorkers.html#remoteEvalM"><span class="hs-identifier hs-var">remoteEvalM</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Closure (Process b)) -&gt; m b)
-&gt; (Closure (Process b) -&gt; m (Closure (Process b)))
-&gt; Closure (Process b)
-&gt; m b
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Closure (Process b) -&gt; m (Closure (Process b))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-110"></span></pre></body></html>